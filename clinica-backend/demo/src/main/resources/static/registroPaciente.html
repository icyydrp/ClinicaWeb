<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Paciente</title>
    <link rel="stylesheet" href="css/registroPaciente.css">
</head>
<body>
    <div class="container">
        <!-- Formulario de registro -->
        <div class="form-container">
            <form id="pacienteForm">
                <h1>Registro de Paciente</h1>
                <span class="custom-span">Completa los datos y Regístrate</span>
                <div class="input-container">
                    <input type="text" id="nombres" name="nombres" placeholder="Nombres" required />
                </div>
                <div class="input-container">
                    <input type="text" id="apellidos" name="apellidos" placeholder="Apellidos" required />
                </div>
                <div class="input-container">
                    <input type="text" id="celular" name="celular" placeholder="Celular" required />
                </div>
                <div class="input-container">
                    <input type="text" id="dni" name="dni" placeholder="DNI" required />
                </div>
                <div class="input-container">
                    <input type="email" id="correo" name="correo" placeholder="Correo Electrónico" required />
                </div>
                <div class="input-container">
                    <input type="password" id="contraseñaPaciente" name="contraseña" placeholder="Contraseña" required />
                    <small id="passwordRequirements" style="color: gray; display: block;">
                        La contraseña debe tener al menos 8 caracteres, incluyendo una letra mayúscula, un número y un símbolo.
                    </small>
                </div>
                <div class="input-container">
                    <input type="password" id="verificarContraseñaPaciente" name="verificarContraseña" placeholder="Verificar Contraseña" required />
                </div>
                <button type="button" id="registrarPacienteBtn">Registrarme</button>
            </form>
        </div>

        <!-- Contenedor del panel de bienvenida -->
        <div class="overlay-container">
            <div class="overlay">
                <div class="overlay-panel overlay-right">
                    <h1>Hola, ¡Bienvenido!</h1>
                    <p>Si ya eres un usuario registrado, inicia sesión haciendo clic en el botón de abajo</p>
                    <button class="ghost" onclick="window.location.href='login.html'">Iniciar Sesión</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('registrarPacienteBtn').addEventListener('click', function () {
            // Obtener los datos del formulario
            const nombres = document.getElementById('nombres').value.trim();
            const apellidos = document.getElementById('apellidos').value.trim();
            const celular = document.getElementById('celular').value.trim();
            const dni = document.getElementById('dni').value.trim();
            const correo = document.getElementById('correo').value.trim();
            const contraseña = document.getElementById('contraseñaPaciente').value.trim();
    
            // Validación de campos vacíos
            if (!nombres || !apellidos || !celular || !dni || !correo || !contraseña) {
                alert('Todos los campos son obligatorios.');
                return;
            }
    
            // Crear un objeto con los datos del paciente
            const pacienteData = {
                nombres: nombres,
                apellidos: apellidos,
                celular: celular,
                dni: dni,
                correo: correo,
                contraseña: contraseña,
            };
    
            // Enviar los datos al backend como JSON usando fetch
            fetch('http://localhost:8080/paciente/registrar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(pacienteData),
            })
                .then((response) => {
                    if (!response.ok) {
                        return response.json().then((errorData) => {
                            throw new Error(errorData.error || 'Error en la solicitud: ' + response.status);
                        });
                    }
                    return response.json();
                })
                .then((data) => {
                    if (data.token) {
                        // Guardar el token en localStorage
                        localStorage.setItem('authToken', data.token);
    
                        // Incluir el token en las solicitudes automáticamente
                        setAuthorizationHeader();
    
                        // Redirigir a la página principal del paciente
                        window.location.href = "/paginaprincipalPaciente.html";
                    } else {
                        throw new Error('No se recibió un token en la respuesta.');
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert('Hubo un error al registrar el paciente: ' + error.message);
                });
        });
    
        // Modificación para incluir el token JWT en todas las solicitudes fetch
        function setAuthorizationHeader() {
            const originalFetch = fetch;
            window.fetch = function () {
                const args = arguments;
    
                if (!args[1]) {
                    args[1] = {};
                }
                if (!args[1].headers) {
                    args[1].headers = {};
                }
    
                // Obtener el token del localStorage
                const token = localStorage.getItem('authToken');
                if (token) {
                    args[1].headers['Authorization'] = 'Bearer ' + token;
                }
    
                return originalFetch.apply(this, arguments);
            };
        }
    
        // Validación de contraseña mientras el usuario escribe
        document.getElementById('contraseñaPaciente').addEventListener('input', function () {
            const contraseña = this.value;
            const passwordRequirements = document.getElementById('passwordRequirements');
            const passwordRegex = /^(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
    
            if (passwordRegex.test(contraseña)) {
                passwordRequirements.style.color = 'green';
                passwordRequirements.textContent = 'La contraseña cumple con los requisitos.';
            } else {
                passwordRequirements.style.color = 'red';
                passwordRequirements.textContent = 'La contraseña debe tener al menos 8 caracteres, incluyendo una letra mayúscula, un número y un símbolo.';
            }
        });
    
        // Validación de coincidencia de contraseñas mientras el usuario escribe
        document.getElementById('verificarContraseñaPaciente').addEventListener('input', function () {
            const contraseña = document.getElementById('contraseñaPaciente').value;
            const verificarContraseña = this.value;
    
            if (contraseña !== verificarContraseña) {
                this.setCustomValidity('Las contraseñas no coinciden.');
            } else {
                this.setCustomValidity('');
            }
        });

        function customFetch(url, options = {}) {
    if (!options.headers) {
        options.headers = {};
    }
    const token = localStorage.getItem('authToken');
    if (token) {
        options.headers['Authorization'] = 'Bearer ' + token;
    }
    return fetch(url, options);
}

    </script>
    
    
</body>
</html>
